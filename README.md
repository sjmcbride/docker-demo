# SMCLab.net Demo Stack

A complete Docker stack with 3 demo websites behind Traefik proxy with automatic SSL certificates, all connecting to a shared PostgreSQL database.

## Architecture

```
Internet → Traefik (SSL/Proxy) → Demo Sites (1,2,3) → PostgreSQL Database
```

### Services

- **Traefik v3.0**: Reverse proxy with automatic Let's Encrypt SSL certificates
- **PostgreSQL 15**: Shared database for all demo applications
- **Demo1-3**: Nginx-powered demo websites with unique themes
- **Networks**: Separated frontend (web) and backend (database) networks

### Domains

- `demo1.smclab.net` - Basic demo site
- `demo2.smclab.net` - Advanced features demo
- `demo3.smclab.net` - Integration demo
- `traefik.smclab.net` - Traefik dashboard

## Quick Start

1. **Clone and Navigate**
   ```bash
   cd docker-demo
   ```

2. **Deploy the Stack**
   ```bash
   chmod +x deploy.sh
   ./deploy.sh
   ```

3. **Verify Deployment**
   ```bash
   docker-compose ps
   docker-compose logs -f
   ```

## DNS Configuration

Before deployment, ensure your DNS records point to your server:

```
demo1.smclab.net    A    YOUR_SERVER_IP
demo2.smclab.net    A    YOUR_SERVER_IP
demo3.smclab.net    A    YOUR_SERVER_IP
traefik.smclab.net  A    YOUR_SERVER_IP
```

## File Structure

```
docker-demo/
├── docker-compose.yml      # Main orchestration file
├── init.sql               # PostgreSQL initialization
├── deploy.sh              # Deployment script
├── demo1/                 # Demo1 website files
│   └── index.html
├── demo2/                 # Demo2 website files
│   └── index.html
├── demo3/                 # Demo3 website files
│   └── index.html
└── letsencrypt/           # SSL certificates (auto-created)
    └── acme.json
```

## Database Access

Connect to PostgreSQL:
- **Host**: localhost:5432
- **Database**: demo_db
- **Username**: demo_user
- **Password**: demo_password

Sample tables created automatically:
- `demo_sites` - Site information
- `visitors` - Visitor tracking

## Management Commands

```bash
# View all services
docker-compose ps

# View logs
docker-compose logs -f

# Restart specific service
docker-compose restart demo1

# Stop entire stack
docker-compose down

# Update and restart
docker-compose pull && docker-compose up -d

# Access database
docker-compose exec postgres psql -U demo_user -d demo_db
```

## SSL Certificates

- Certificates are automatically generated by Let's Encrypt
- Stored in `./letsencrypt/acme.json`
- Auto-renewal handled by Traefik
- HTTP automatically redirects to HTTPS

## Monitoring

- **Traefik Dashboard**: https://traefik.smclab.net
- **Container Logs**: `docker-compose logs -f [service]`
- **Service Health**: `docker-compose ps`

## Customization

### Adding New Sites

1. Add service to `docker-compose.yml`:
   ```yaml
   demo4:
     image: nginx:alpine
     volumes:
       - ./demo4:/usr/share/nginx/html
     labels:
       - "traefik.enable=true"
       - "traefik.http.routers.demo4.rule=Host(`demo4.smclab.net`)"
       - "traefik.http.routers.demo4.entrypoints=websecure"
       - "traefik.http.routers.demo4.tls.certresolver=myresolver"
   ```

2. Create content directory:
   ```bash
   mkdir demo4
   echo "<h1>Demo4</h1>" > demo4/index.html
   ```

### Database Modifications

Edit `init.sql` to modify the database schema or add sample data.

## Troubleshooting

### SSL Certificate Issues
```bash
# Check certificate status
docker-compose exec traefik cat /letsencrypt/acme.json

# Restart Traefik
docker-compose restart traefik
```

### Database Connection Issues
```bash
# Check PostgreSQL logs
docker-compose logs postgres

# Test database connection
docker-compose exec postgres pg_isready -U demo_user
```

### Service Discovery Issues
```bash
# Check Traefik configuration
docker-compose logs traefik

# Verify labels
docker inspect demo1 | grep -A 10 Labels
```

## Security Notes

- Database password should be changed in production
- Consider using Docker secrets for sensitive data
- Review Traefik security settings for production use
- Regular backup of PostgreSQL data recommended

## Support

For issues or questions:
- Check service logs: `docker-compose logs [service]`
- Verify DNS configuration
- Ensure ports 80/443 are accessible
- Check Docker and Docker Compose versions